<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VWP2QKP7N9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-VWP2QKP7N9');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Treelemetry ðŸŽ„ðŸ’§ - Christmas Tree Water Level Monitor</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="/src/style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸŽ„ Treelemetry ðŸ’§</h1>
    </header>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Loading water level data...</p>
    </div>

    <div id="error" class="error" style="display: none;">
      <p>Failed to load data. Please try again later.</p>
    </div>

    <main id="main-content" style="display: none;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Water Level</div>
          <div class="stat-value" id="current-level">--</div>
          <div class="stat-unit" id="mm">mm from sensor</div>
          <div class="stat-unit" id="ml">mL depleted (est.)</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Estimated Time to Refill</div>
          <div class="stat-value" id="time-to-refill">--</div>
          <div class="stat-unit" id="refill-unit">hours</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Measurement Frequency</div>
          <div class="stat-value" id="measurement-frequency">--</div>
          <div class="stat-unit">Hz</div>
        </div>
      </div>

      <div class="stats-grid stats-grid-secondary">
        <div class="stat-card">
          <div class="stat-label">Water Temperature</div>
          <div class="stat-value" id="water-temp">--</div>
          <div class="stat-unit">Â°F</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Air Temperature</div>
          <div class="stat-value" id="air-temp">--</div>
          <div class="stat-unit">Â°F</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Humidity</div>
          <div class="stat-value" id="humidity">--</div>
          <div class="stat-unit">%</div>
        </div>
      </div>

      <!-- Real-time Chart (Last 10 Minutes) -->
      <div class="chart-container">
        <div class="chart-header">
          <h2>Water Level Monitor (Real-time)</h2>
          <p><em>All values delayed 5 minutes. For real-time data, contact enterprise sales.</em></p>
          <div class="controls-row">
            <div class="units-toggle">
              <button class="units-btn active" data-unit="mm">mm</button>
              <button class="units-btn" data-unit="mL">mL</button>
            </div>
          </div>
        </div>
        <div class="chart-scroll-wrapper">
          <div class="chart-canvas-wrapper">
            <canvas id="water-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- Daily View (5-minute aggregates, last 24 hours) -->
      <div class="chart-container">
        <div class="chart-header">
          <h2>Last 24 Hours (5-minute intervals)</h2>
          <p><em>Aggregated view with mean, min, max</em></p>
        </div>
        <div class="chart-scroll-wrapper">
          <div class="chart-canvas-wrapper">
            <canvas id="chart-5m"></canvas>
          </div>
        </div>
      </div>

      <!-- Historical View (1-hour aggregates, all time) -->
      <div class="chart-container">
        <div class="chart-header">
          <h2>All Historical Data (1-hour intervals)</h2>
          <p><em>Complete history with hourly aggregates</em></p>
        </div>
        <div class="chart-scroll-wrapper">
          <div class="chart-canvas-wrapper">
            <canvas id="chart-1h"></canvas>
          </div>
        </div>
      </div>

       <!-- Slope Trends -->
       <div class="chart-container">
        <div class="chart-header">
          <h2>Consumption Rate Trends</h2>
          <p><em>Water consumption rate (slope) for each detected segment over time</em></p>
        </div>
        <div class="chart-scroll-wrapper">
          <div class="chart-canvas-wrapper">
            <canvas id="chart-slopes"></canvas>
          </div>
        </div>
      </div>

      <!-- Segment Analysis: Consumption Periods with Extrema -->
      <div class="chart-container">
        <div class="chart-header">
          <h2>Consumption Segments & Refill Events</h2>
          <p><em>Detected consumption periods with linear fits, showing refill events (minima) and needs-refill points (maxima)</em></p>
        </div>
        <div class="chart-scroll-wrapper">
          <div class="chart-canvas-wrapper">
            <canvas id="chart-segments"></canvas>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h3>About</h3>
        <p>
          Water level data reflects the distance from water surface to a VL6180X time-of-flight laser interferometer distance ranging sensor situated at the rim of my Christmas tree stand. These readings are collected by an ESP8266 micocontroller and posted via wifi to an MQTT server on a Raspberry Pi on the local network. Separately, Yolink sensors collect water and air environmental readings and post them to a separate local MQTT server. A dockerized process on a Terramaster NAS observes the MQTT messages and writes them to a duckdb file. A separate docker process periodically queries the duckdb file, aggregates data into varying levels of precision, and analyzes changes in the rate of water consumption via a process that involves outlier removal, data smoothing, detection of local minima/maxima, and linear regression. The results are assembled into a JSON file, gzipped, and uploaded to S3 with appropriate ACLs using IAM best practices.
        </p>
        <p>
            Raw data is expressed in millimeters; all volumetric measurements should be considered approximate.
        </p>
        <p>
            Watering performed using <a href="https://www.amazon.com/dp/B0BGJP5YWW?ref=ppx_yo2ov_dt_b_fed_asin_title">Rocky Mountain Goods Christmas Tree Food</a>.
        </p>
          <span id="data-window"></span>
        </p>
        <p class="last-update">
          Last updated: <span id="last-update-time">--</span>
        </p>
      </div>
    </main>

    <footer>
      <a href="https://github.com/sbma44/treelemetry" target="_blank" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
      </a>
    </footer>
  </div>
  <christmas-lights></christmas-lights>
  <script type="module" src="/src/main.js"></script>
</body>
</html>

